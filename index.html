<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCnZ3AjNQ4BFkNch5ybCkYv2TT-GwHzU3U",
    authDomain: "oliver-s-quiz-game.firebaseapp.com",
    databaseURL: "https://oliver-s-quiz-game-default-rtdb.firebaseio.com",
    projectId: "oliver-s-quiz-game",
    storageBucket: "oliver-s-quiz-game.appspot.com",
    messagingSenderId: "723449396892",
    appId: "1:723449396892:web:ef7f27418c17ea17092431"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function syncBuzz(playerName, playerIndex) {
    db.ref('buzzed').once('value').then(snapshot => {
      if (!snapshot.exists()) {
        db.ref('buzzed').set({ name: playerName, index: playerIndex });
      }
    });
  }

  function syncScore(name, delta) {
    const ref = db.ref(`scores/${name}`);
    ref.once('value').then(snap => {
      const current = snap.val() || 0;
      ref.set(current + delta);
    });
  }

  function resetGame() {
    db.ref('buzzed').remove();
  }

  function initFirebaseListeners() {
    db.ref('buzzed').on('value', snapshot => {
      const data = snapshot.val();
      if (data) {
        const playerIndex = data.index;
        const playerName = data.name;
        status.textContent = `${playerName} buzzed first!`;
        isBuzzerActive = false;
        buzzers.forEach(btn => {
          btn.classList.add('disabled');
          btn.disabled = true;
        });
        if (buzzers[playerIndex]) {
          buzzers[playerIndex].classList.remove('disabled');
          buzzers[playerIndex].disabled = false;
          playBeep(buzzerFrequencies[playerIndex % buzzerFrequencies.length], 0.3);
        }
      } else {
        isBuzzerActive = true;
        status.textContent = 'Ready';
        buzzers.forEach(btn => {
          btn.classList.remove('disabled');
          btn.disabled = false;
        });
      }
    });
  }

  function generateBuzzers(numPlayers) {
    buzzerRow.innerHTML = '';
    buzzers = [];
    nameInputs = [];
    scoreInputs = [];

    for (let i = 0; i < numPlayers; i++) {
      const buzzerContainer = document.createElement('div');
      buzzerContainer.className = 'buzzer-container';

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = `Player ${i + 1}`;
      nameInput.className = 'name-input';

      const buzzer = document.createElement('button');
      buzzer.textContent = `Buzz ${i + 1}`;
      buzzer.className = 'buzzer';

      const scoreInput = document.createElement('input');
      scoreInput.type = 'number';
      scoreInput.value = '0';
      scoreInput.className = 'score-input';
      scoreInput.readOnly = true;

      buzzerContainer.appendChild(nameInput);
      buzzerContainer.appendChild(buzzer);
      buzzerContainer.appendChild(scoreInput);
      buzzerRow.appendChild(buzzerContainer);

      buzzers.push(buzzer);
      nameInputs.push(nameInput);
      scoreInputs.push(scoreInput);

      attachMultiplayerListeners(i, nameInput, buzzer);
    }
  }

  window.addEventListener('load', () => {
    initFirebaseListeners();
    resetButton.addEventListener('click', () => {
      resetGame();
    });
  });
</script>

<script>
  function attachMultiplayerListeners(i, nameInput, buzzer) {
    buzzer.addEventListener('click', () => {
      if (isBuzzerActive) {
        const playerName = nameInput.value.trim() || `Player ${i + 1}`;
        syncBuzz(playerName, i);
        syncScore(playerName, 1000);
      }
    });
  }
</script>
