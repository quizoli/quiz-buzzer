<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="page-title">Oliver's Quiz Game</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background-color: #f0f0f0; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; }
    .buzzer-row { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
    .buzzer-container { margin: 10px; text-align: center; }
    .buzzer { width: 100px; height: 100px; border: none; border-radius: 50%; font-size: 16px; cursor: pointer; transition: transform 0.1s ease; }
    .buzzer:active { transform: scale(0.95); }
    .disabled { background-color: #ccc !important; cursor: not-allowed; }
    .name-input, .header-input, .players-input, .password-input, .slot-select { padding: 8px; font-size: 16px; width: 150px; }
    .score-input { padding: 8px; font-size: 16px; width: 60px; margin: 0 5px; }
    .score-btn { padding: 5px 12px; margin: 0 2px; font-size: 18px; border-radius: 10px; border: none; }
    .header-container, .players-container, .password-container, .login-container { margin-bottom: 20px; }
    #login-screen { display: block; margin-top: 50px; }
    #password-screen, #game-screen { display: none; }
    #timer-container { margin-top: 15px; margin-bottom: 15px; }
    #timer { font-size: 2em; padding: 10px; margin-right: 20px;}
    #timer-controls button { padding: 8px 18px; margin: 0 5px; font-size: 1em; border-radius: 8px; border: none;}
    #timer-input { width: 70px; font-size: 1.2em; margin-right: 12px; }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="login-screen" class="container">
    <h1>Oliver's Quiz Game</h1>
    <div class="login-container">
      <button id="host-login-btn">Login as Host</button>
      <button id="player-login-btn">Login as Player</button>
    </div>
  </div>
  <div id="password-screen" class="container">
    <h2>Host Authentication</h2>
    <div class="password-container">
      <label>Password:</label>
      <input type="password" id="password-input" class="password-input">
      <button id="auth-button" class="auth-button">Login</button>
    </div>
    <div id="auth-error" style="color: red; margin-top: 10px;"></div>
  </div>
  <div id="player-setup-screen" class="container" style="display:none;">
    <h2>Player Login</h2>
    <div class="login-container">
      <label>Choose Player Slot:</label>
      <select id="player-slot" class="slot-select">
        <option value="0">Player 1</option>
        <option value="1">Player 2</option>
        <option value="2">Player 3</option>
        <option value="3">Player 4</option>
        <option value="4">Player 5</option>
        <option value="5">Player 6</option>
        <option value="6">Player 7</option>
        <option value="7">Player 8</option>
      </select>
      <br/><br/>
      <label>Your Name:</label>
      <input type="text" id="player-name-input" class="name-input">
      <button id="player-login-confirm-btn">Login</button>
    </div>
    <div id="player-login-error" style="color: red; margin-top: 10px;"></div>
  </div>
  <div id="game-screen" class="container">
    <div class="header-container">
      <label>Quiz Title:</label>
      <input type="text" id="header-input" class="header-input" value="Oliver's Quiz Game">
    </div>
    <h1 id="main-header">Oliver's Quiz Game</h1>
    <div class="players-container">
      <label>Number of Players (2-8):</label>
      <input type="number" id="players-input" class="players-input" value="4" min="2" max="8">
    </div>
    <div id="timer-container">
      <input type="number" id="timer-input" min="1" value="30" /> seconds
      <span id="timer">00:30.0</span>
      <span id="timer-controls">
        <button id="start-timer-btn">Start</button>
        <button id="stop-timer-btn">Stop</button>
        <button id="reset-timer-btn">Reset</button>
      </span>
    </div>
    <div id="status">Ready</div>
    <div id="buzzer-row" class="buzzer-row"></div>
    <button id="reset" style="margin-top:20px;">Reset</button>
  </div>
  <script>
    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyAN7_tf4JxF4rzafGLZidbuUlPSxNPgyvE",
      authDomain: "oliver-s-quiz-game.firebaseapp.com",
      databaseURL: "https://oliver-s-quiz-game-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "oliver-s-quiz-game",
      storageBucket: "oliver-s-quiz-game.firebasestorage.app",
      messagingSenderId: "273095657187",
      appId: "1:273095657187:web:4bc4b0f662d3c60afd27d6",
      measurementId: "G-T13MW2BD3Z"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const settingsRef = db.ref('games/quizGame/settings');
    const buzzRef = db.ref('games/quizGame/buzz');
    const namesRef = db.ref('games/quizGame/names');
    const scoresRef = db.ref('games/quizGame/scores');
    const timerRef = db.ref('games/quizGame/timer');

    // --- DOM ---
    const loginScreen = document.getElementById('login-screen');
    const passwordScreen = document.getElementById('password-screen');
    const gameScreen = document.getElementById('game-screen');
    const authButton = document.getElementById('auth-button');
    const passwordInput = document.getElementById('password-input');
    const hostLoginBtn = document.getElementById('host-login-btn');
    const playerLoginBtn = document.getElementById('player-login-btn');
    const playerSetupScreen = document.getElementById('player-setup-screen');
    const playerSlot = document.getElementById('player-slot');
    const playerNameInput = document.getElementById('player-name-input');
    const playerLoginConfirmBtn = document.getElementById('player-login-confirm-btn');
    const playerLoginError = document.getElementById('player-login-error');
    const headerInput = document.getElementById('header-input');
    const mainHeader = document.getElementById('main-header');
    const pageTitle = document.getElementById('page-title');
    const playersInput = document.getElementById('players-input');
    const statusEl = document.getElementById('status');
    const buzzerRow = document.getElementById('buzzer-row');
    const resetButton = document.getElementById('reset');
    const timerInput = document.getElementById('timer-input');
    const timerEl = document.getElementById('timer');
    const startTimerBtn = document.getElementById('start-timer-btn');
    const stopTimerBtn = document.getElementById('stop-timer-btn');
    const resetTimerBtn = document.getElementById('reset-timer-btn');

    // --- App State ---
    let isHost = false;
    let playerIndex = null;
    let currentNames = [], currentScores = [];
    let buzzers = [], nameInputs = [], scoreInputs = [];
    let isBuzzerActive = true;
    let timerInterval = null, timerSyncRunning = false, timerSyncEnd = 0;
    const buzzerColors = ['#ff4d4d','#4d79ff','#4dff4d','#ffcc00','#ff33cc','#33cccc','#cc33ff','#ff9933'];
    const buzzerFreqs  = [440,523.25,659.25,880,987.77,1108.73,1318.51,1760];

    // --- Login Logic ---
    hostLoginBtn.onclick = () => {
      loginScreen.style.display = 'none';
      passwordScreen.style.display = 'block';
    };
    playerLoginBtn.onclick = () => {
      loginScreen.style.display = 'none';
      playerSetupScreen.style.display = 'block';
    };
    authButton.onclick = () => {
      if (passwordInput.value === 'quizmaster123') {
        isHost = true;
        passwordScreen.style.display = 'none';
        launchGame();
      } else {
        document.getElementById('auth-error').textContent = 'Incorrect password!';
      }
    };
    playerLoginConfirmBtn.onclick = () => {
      let idx = Number(playerSlot.value);
      let name = playerNameInput.value.trim();
      if (!name) {
        playerLoginError.textContent = "Enter your name!";
        return;
      }
      // Check if that slot is taken (name set by host)
      namesRef.once('value').then(snap => {
        let arr = snap.exists() ? snap.val() : [];
        if (arr[idx] && arr[idx] !== name) {
          playerLoginError.textContent = "Host assigned this slot to another name.";
          return;
        }
        playerIndex = idx;
        // Update name for this slot in Firebase
        arr[idx] = name;
        namesRef.set(arr);
        playerSetupScreen.style.display = 'none';
        launchGame();
      });
    };

    // --- Main Game UI & Sync Logic ---
    function launchGame() {
      gameScreen.style.display = 'block';
      // Host sets default names/scores/timer
      if (isHost) {
        playersInput.disabled = false;
        headerInput.disabled = false;
        timerInput.disabled = false;
        startTimerBtn.disabled = false;
        stopTimerBtn.disabled = false;
        resetTimerBtn.disabled = false;
        resetButton.disabled = false;
      } else {
        playersInput.disabled = true;
        headerInput.disabled = true;
        timerInput.disabled = true;
        startTimerBtn.disabled = true;
        stopTimerBtn.disabled = true;
        resetTimerBtn.disabled = true;
        resetButton.disabled = true;
      }
      // Pull current data and render buzzers
      Promise.all([
        settingsRef.once('value'),
        namesRef.once('value'),
        scoresRef.once('value'),
        timerRef.once('value')
      ]).then(([snapSet, snapN, snapS, snapT]) => {
        let nPlayers = snapSet.exists() && snapSet.val().numPlayers ? snapSet.val().numPlayers : 4;
        let header = snapSet.exists() && snapSet.val().header ? snapSet.val().header : "Oliver's Quiz Game";
        let arrN = snapN.exists() ? snapN.val() : Array(nPlayers).fill('');
        let arrS = snapS.exists() ? snapS.val() : Array(nPlayers).fill(0);
        currentNames = arrN;
        currentScores = arrS;
        playersInput.value = nPlayers;
        headerInput.value = header;
        mainHeader.textContent = header;
        pageTitle.textContent = header;
        generateBuzzers(nPlayers, arrN, arrS);
        if (snapT.exists()) timerEl.textContent = formatTime(snapT.val().timeLeft || snapT.val().base || 30);
      });
    }

    function generateBuzzers(count, namesArray = [], scoresArray = []) {
      buzzerRow.innerHTML = '';
      buzzers = []; nameInputs = []; scoreInputs = [];
      for (let i = 0; i < count; i++) {
        const container = document.createElement('div'); container.className = 'buzzer-container';
        // Name
        const input = document.createElement('input');
        input.type = 'text'; input.placeholder = `Player ${i+1} Name`;
        input.className = 'name-input';
        input.value = namesArray[i] || '';
        if (!isHost) input.disabled = true;
        input.addEventListener('change', () => {
          if (isHost) {
            currentNames[i] = input.value;
            namesRef.set(currentNames);
          }
        });
        container.appendChild(input);
        // Buzzer
        const btn = document.createElement('button');
        btn.textContent = `Player ${i+1}`;
        btn.className = 'buzzer'; btn.style.backgroundColor = buzzerColors[i];
        btn.disabled = !isBuzzerActive || (!isHost && playerIndex !== i);
        btn.addEventListener('click', () => {
          if (isHost || playerIndex === i) {
            buzzRef.once('value').then(snap => {
              if (!snap.exists()) {
                const name = input.value.trim() || `Player ${i+1}`;
                buzzRef.set({ index: i, name, freq: buzzerFreqs[i], ts: Date.now() });
              }
            });
          }
        });
        container.appendChild(btn);
        // Score
        const minusBtn = document.createElement('button');
        minusBtn.textContent = '-';
        minusBtn.className = 'score-btn';
        const score = document.createElement('input');
        score.type = 'number';
        score.value = scoresArray[i] || 0;
        score.className = 'score-input';
        score.disabled = !isHost;
        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+';
        plusBtn.className = 'score-btn';
        minusBtn.disabled = plusBtn.disabled = !isHost;
        minusBtn.onclick = () => {
          if (isHost) {
            currentScores[i] = Math.max(0, Number(score.value) - 1000);
            scoresRef.set(currentScores);
          }
        };
        plusBtn.onclick = () => {
          if (isHost) {
            currentScores[i] = Number(score.value) + 1000;
            scoresRef.set(currentScores);
          }
        };
        score.addEventListener('change', () => {
          if (isHost) {
            currentScores[i] = Number(score.value) || 0;
            scoresRef.set(currentScores);
          }
        });
        container.appendChild(minusBtn);
        container.appendChild(score);
        container.appendChild(plusBtn);
        buzzerRow.appendChild(container);
        buzzers.push(btn);
        nameInputs.push(input);
        scoreInputs.push(score);
      }
    }

    // Timer Sync
    function formatTime(t) {
      const min = Math.floor(t/60), sec = Math.floor(t%60), dsec = Math.floor((t*10)%10);
      return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}.${dsec}`;
    }
    function playBeep(frequency, duration) {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      const audioCtx     = new AudioContext();
      const gap = 0.05;
      const now = audioCtx.currentTime;
      const osc1 = audioCtx.createOscillator();
      const gain1 = audioCtx.createGain();
      osc1.connect(gain1); gain1.connect(audioCtx.destination);
      osc1.type = 'sine'; osc1.frequency.setValueAtTime(frequency, now);
      gain1.gain.setValueAtTime(0.5, now);
      osc1.start(now); osc1.stop(now + duration);
      const osc2 = audioCtx.createOscillator();
      const gain2 = audioCtx.createGain();
      osc2.connect(gain2); gain2.connect(audioCtx.destination);
      osc2.type = 'sine'; osc2.frequency.setValueAtTime(frequency * 1.25, now + duration + gap);
      gain2.gain.setValueAtTime(0.5, now + duration + gap);
      osc2.start(now + duration + gap); osc2.stop(now + 2*duration + gap);
    }
    function playAlarm() {
      let i = 0;
      function beep() {
        playBeep(1760, 0.2);
        i++;
        if (i < 3) setTimeout(beep, 300);
      }
      beep();
    }
    let localTimerInterval = null;
    startTimerBtn.onclick = function() {
      if (isHost) {
        let t = Number(timerInput.value) || 30;
        timerRef.set({
          running: true,
          base: t,
          start: Date.now(),
          timeLeft: t
        });
      }
    };
    stopTimerBtn.onclick = function() {
      if (isHost) timerRef.child("running").set(false);
    };
    resetTimerBtn.onclick = function() {
      if (isHost) {
        let t = Number(timerInput.value) || 30;
        timerRef.set({
          running: false,
          base: t,
          start: Date.now(),
          timeLeft: t
        });
      }
    };
    timerInput.addEventListener('change', function() {
