<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="page-title">Oliver's Quiz Game</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background-color: #f0f0f0; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; }
    .buzzer-row { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
    .buzzer-container { margin: 10px; text-align: center; }
    .buzzer { width: 100px; height: 100px; border: none; border-radius: 50%; font-size: 16px; cursor: pointer; transition: transform 0.1s ease; }
    .buzzer:active { transform: scale(0.95); }
    .disabled { background-color: #ccc !important; cursor: not-allowed; }
    .name-input, .header-input, .players-input, .password-input { padding: 8px; font-size: 16px; width: 150px; }
    .score-input { padding: 8px; font-size: 16px; width: 60px; margin: 0 5px; }
    .score-btn { padding: 5px 12px; margin: 0 2px; font-size: 18px; border-radius: 10px; border: none; }
    .header-container, .players-container, .password-container { margin-bottom: 20px; }
    #password-screen { display: block; margin-top: 50px; }
    #game-screen { display: none; }
    #timer-container { margin-top: 15px; margin-bottom: 15px; }
    #timer { font-size: 2em; padding: 10px; margin-right: 20px;}
    #timer-controls button { padding: 8px 18px; margin: 0 5px; font-size: 1em; border-radius: 8px; border: none;}
    #timer-input { width: 70px; font-size: 1.2em; margin-right: 12px; }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="password-screen" class="container">
    <h1>Authenticate</h1>
    <div class="password-container">
      <label>Enter Password:</label>
      <input type="password" id="password-input" class="password-input">
      <button id="auth-button" class="auth-button">Submit</button>
    </div>
    <div id="auth-error" style="color: red; margin-top: 10px;"></div>
  </div>

  <div id="game-screen" class="container">
    <div class="header-container">
      <label>Quiz Title:</label>
      <input type="text" id="header-input" class="header-input" value="Oliver's Quiz Game">
    </div>
    <h1 id="main-header">Oliver's Quiz Game</h1>
    <div class="players-container">
      <label>Number of Players (2-8):</label>
      <input type="number" id="players-input" class="players-input" value="4" min="2" max="8">
    </div>
    <div id="timer-container">
      <input type="number" id="timer-input" min="1" value="30" /> seconds
      <span id="timer">00:30.0</span>
      <span id="timer-controls">
        <button onclick="startTimer()">Start</button>
        <button onclick="stopTimer()">Stop</button>
        <button onclick="resetTimer()">Reset</button>
      </span>
    </div>
    <div id="status">Ready</div>
    <div id="buzzer-row" class="buzzer-row"></div>
    <button id="reset" style="margin-top:20px;">Reset</button>
  </div>
  <script>
    // === Firebase Initialization (Your Real Config) ===
    const firebaseConfig = {
      apiKey: "AIzaSyAN7_tf4JxF4rzafGLZidbuUlPSxNPgyvE",
      authDomain: "oliver-s-quiz-game.firebaseapp.com",
      databaseURL: "https://oliver-s-quiz-game-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "oliver-s-quiz-game",
      storageBucket: "oliver-s-quiz-game.firebasestorage.app",
      messagingSenderId: "273095657187",
      appId: "1:273095657187:web:4bc4b0f662d3c60afd27d6",
      measurementId: "G-T13MW2BD3Z"
    };
    firebase.initializeApp(firebaseConfig);
    const db          = firebase.database();
    const settingsRef = db.ref('games/quizGame/settings');
    const buzzRef     = db.ref('games/quizGame/buzz');

    // === DOM References ===
    const passwordScreen = document.getElementById('password-screen');
    const gameScreen     = document.getElementById('game-screen');
    const passwordInput  = document.getElementById('password-input');
    const authButton     = document.getElementById('auth-button');
    const playersInput   = document.getElementById('players-input');
    const headerInput    = document.getElementById('header-input');
    const mainHeader     = document.getElementById('main-header');
    const pageTitle      = document.getElementById('page-title');
    const statusEl       = document.getElementById('status');
    const buzzerRow      = document.getElementById('buzzer-row');
    const resetButton    = document.getElementById('reset');
    const timerInput     = document.getElementById('timer-input');
    const timerEl        = document.getElementById('timer');

    // === Audio Setup ===
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx     = new AudioContext();
    function playBeep(frequency, duration) {
      const gap = 0.05;
      const now = audioCtx.currentTime;
      const osc1 = audioCtx.createOscillator();
      const gain1 = audioCtx.createGain();
      osc1.connect(gain1); gain1.connect(audioCtx.destination);
      osc1.type = 'sine'; osc1.frequency.setValueAtTime(frequency, now);
      gain1.gain.setValueAtTime(0.5, now);
      osc1.start(now); osc1.stop(now + duration);
      const osc2 = audioCtx.createOscillator();
      const gain2 = audioCtx.createGain();
      osc2.connect(gain2); gain2.connect(audioCtx.destination);
      osc2.type = 'sine'; osc2.frequency.setValueAtTime(frequency * 1.25, now + duration + gap);
      gain2.gain.setValueAtTime(0.5, now + duration + gap);
      osc2.start(now + duration + gap); osc2.stop(now + 2*duration + gap);
    }
    function playAlarm() {
      // Simple alarm: three quick high beeps
      let i = 0;
      function beep() {
        playBeep(1760, 0.2);
        i++;
        if (i < 3) setTimeout(beep, 300);
      }
      beep();
    }

    // === Buzzer State ===
    let isBuzzerActive = true;
    let buzzers = [], nameInputs = [], scoreInputs = [];
    const buzzerColors = ['#ff4d4d','#4d79ff','#4dff4d','#ffcc00','#ff33cc','#33cccc','#cc33ff','#ff9933'];
    const buzzerFreqs  = [440,523.25,659.25,880,987.77,1108.73,1318.51,1760];

    function generateBuzzers(count) {
      buzzerRow.innerHTML = '';
      buzzers = [];
      nameInputs = [];
      scoreInputs = [];
      for (let i = 0; i < count; i++) {
        const container = document.createElement('div'); container.className = 'buzzer-container';
        const input = document.createElement('input');
        input.type = 'text'; input.placeholder = `Player ${i+1} Name`;
        input.className = 'name-input'; container.appendChild(input);
        const btn = document.createElement('button');
        btn.textContent = `Player ${i+1}`;
        btn.className = 'buzzer'; btn.style.backgroundColor = buzzerColors[i];
        btn.disabled = !isBuzzerActive;
        btn.addEventListener('click', () => {
          buzzRef.once('value').then(snap => {
            if (!snap.exists()) {
              const name = input.value.trim() || `Player ${i+1}`;
              buzzRef.set({ index: i, name, freq: buzzerFreqs[i], ts: Date.now() });
            }
          });
        });
        container.appendChild(btn);

        // Score controls
        const minusBtn = document.createElement('button');
        minusBtn.textContent = '-';
        minusBtn.className = 'score-btn';
        const score = document.createElement('input');
        score.type = 'number';
        score.value = 0;
        score.className = 'score-input';
        const plusBtn = document.createElement('button');
        plusBtn.textContent = '+';
        plusBtn.className = 'score-btn';
        minusBtn.onclick = () => score.value = Math.max(0, Number(score.value) - 1000);
        plusBtn.onclick = () => score.value = Number(score.value) + 1000;
        container.appendChild(minusBtn);
        container.appendChild(score);
        container.appendChild(plusBtn);

        buzzerRow.appendChild(container);
        buzzers.push(btn);
        nameInputs.push(input);
        scoreInputs.push(score);
      }
    }

    // === Countdown Timer ===
    let timerInterval = null, timeLeft = 30, timerRunning = false;

    function updateTimerDisplayCountdown() {
      const min = Math.floor(timeLeft/60), sec = Math.floor(timeLeft%60), dsec = Math.floor((timeLeft*10)%10);
      timerEl.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}.${dsec}`;
    }
    function startTimer() {
      if (!timerRunning) {
        timerRunning = true;
        if (timeLeft <= 0) {
          timeLeft = Number(timerInput.value) || 30;
        }
        timerInterval = setInterval(() => {
          timeLeft -= 0.1;
          if (timeLeft <= 0) {
            timeLeft = 0;
            updateTimerDisplayCountdown();
            stopTimer();
            playAlarm();
          } else {
            updateTimerDisplayCountdown();
          }
        }, 100);
      }
    }
    function stopTimer() {
      if (timerRunning) {
        timerRunning = false;
        clearInterval(timerInterval);
        updateTimerDisplayCountdown();
      }
    }
    function resetTimer() {
      timerRunning = false;
      clearInterval(timerInterval);
      timeLeft = Number(timerInput.value) || 30;
      updateTimerDisplayCountdown();
    }
    timerInput.addEventListener('change', () => {
      resetTimer();
    });
    // Timer controls globally accessible
    window.startTimer = startTimer;
    window.stopTimer = stopTimer;
    window.resetTimer = resetTimer;
    resetTimer();

    // === Event Handlers ===
    authButton.addEventListener('click', () => {
      if (passwordInput.value === 'quizmaster123') {
        passwordScreen.style.display = 'none'; gameScreen.style.display = 'block';
        let n = Math.max(2, Math.min(8, parseInt(playersInput.value) || 4));
        settingsRef.set({ header: headerInput.value.trim(), numPlayers: n });
        generateBuzzers(n); // <-- ensure local update for host
        buzzRef.remove();
      } else {
        document.getElementById('auth-error').textContent = 'Incorrect password.';
      }
    });
    resetButton.addEventListener('click', () => { buzzRef.remove(); playBeep(220,0.2); });

    // Update buzzers when players selection changes (immediate for all, including host)
    playersInput.addEventListener('input', () => {
      let n = Math.max(2, Math.min(8, parseInt(playersInput.value) || 4));
      settingsRef.set({ header: headerInput.value.trim(), numPlayers: n });
      generateBuzzers(n);
      buzzRef.remove();
    });

    headerInput.addEventListener('change', () => {
      settingsRef.set({ header: headerInput.value.trim(), numPlayers: parseInt(playersInput.value) });
    });

    document.addEventListener('keydown', e => {
      if (e.key >= '1' && e.key <= '8') buzzers[parseInt(e.key)-1]?.click();
      if (e.key.toLowerCase()==='r') resetButton.click();
    });

    // === Real-time Listeners ===
    settingsRef.on('value', snap => {
      const s = snap.val(); if (!s) return;
      headerInput.value = s.header;
      mainHeader.textContent = s.header;
      pageTitle.textContent  = s.header;
      if (parseInt(playersInput.value) !== s.numPlayers) {
        playersInput.value = s.numPlayers;
        generateBuzzers(s.numPlayers);
      }
    });
    buzzRef.on('value', snap => {
      const b = snap.val();
      if (b) {
        isBuzzerActive = false;
        statusEl.textContent = `${b.name} buzzed first!`;
        playBeep(b.freq,0.3);
        buzzers.forEach(btn => btn.disabled = true);
        buzzers[b.index].disabled = false;
      } else {
        isBuzzerActive = true;
        statusEl.textContent = 'Ready';
        buzzers.forEach(btn => btn.disabled = false);
      }
    });

    // === Initial Launch ===
    generateBuzzers(parseInt(playersInput.value) || 4);
  </script>
</body>
</html>
