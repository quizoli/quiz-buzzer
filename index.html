  // Firebase config is already set above.
  // ...all DOM selections and variables above...

  // --- Game lock until host logs in
  function showWaitingForHost() {
    loginScreen.style.display = 'block';
    waitingHost.style.display = 'block';
    document.querySelector('.login-container').style.display = 'none';
  }
  function hideWaitingForHost() {
    waitingHost.style.display = 'none';
    document.querySelector('.login-container').style.display = 'block';
  }
  hostPresenceRef.on('value', snap => {
    hostPresent = snap.val() === true;
    if (!hostPresent) showWaitingForHost();
    else hideWaitingForHost();
  });

  // --- Host login logic
  hostLoginBtn.onclick = () => {
    loginScreen.style.display = 'none';
    passwordScreen.style.display = 'block';
    passwordInput.value = '';
    document.getElementById('auth-error').textContent = '';
    passwordInput.focus();
  };
  function doHostLogin() {
    if (passwordInput.value === 'quizmaster123') {
      isHost = true;
      passwordScreen.style.display = 'none';
      hostPresenceRef.set(true);
      window.addEventListener('beforeunload', () => hostPresenceRef.set(false));
      leaveBtn.style.display = 'block';
      launchGame();
    } else {
      document.getElementById('auth-error').textContent = 'Incorrect password!';
      passwordInput.value = '';
      passwordInput.focus();
    }
  }
  authButton.onclick = doHostLogin;
  passwordInput.addEventListener('keydown', function(e) {
    if (e.key === "Enter") doHostLogin();
  });

  // --- Player login logic
  playerLoginBtn.onclick = () => {
    hostPresenceRef.once('value').then(snap => {
      if (!snap.val()) {
        alert("Please wait for the host to join before logging in.");
        return;
      }
      loginScreen.style.display = 'none';
      playerSetupScreen.style.display = 'block';
      playerLoginError.textContent = '';
      playerNameInput.value = '';
      playerNameInput.focus();
    });
  };
  function doPlayerLogin() {
    let idx = Number(playerSlot.value);
    let name = playerNameInput.value.trim();
    if (!name) {
      playerLoginError.textContent = "Enter your name!";
      playerNameInput.focus();
      return;
    }
    namesRef.once('value').then(snap => {
      let arr = snap.exists() ? snap.val() : [];
      if (arr[idx] && arr[idx] !== name) {
        playerLoginError.textContent = "Host assigned this slot to another name.";
        playerNameInput.focus();
        return;
      }
      playerIndex = idx;
      arr[idx] = name;
      namesRef.set(arr);
      playerSetupScreen.style.display = 'none';
      leaveBtn.style.display = 'block';
      launchGame();
    });
  }
  playerLoginConfirmBtn.onclick = doPlayerLogin;
  playerNameInput.addEventListener('keydown', function(e) {
    if (e.key === "Enter") doPlayerLogin();
  });

  // --- Leave Game logic ---
  leaveBtn.onclick = function() {
    if (isHost) {
      hostPresenceRef.set(false);
      window.location.reload();
    } else if (playerIndex !== null) {
      namesRef.once('value').then(snap => {
        let arr = snap.exists() ? snap.val() : [];
        arr[playerIndex] = '';
        namesRef.set(arr);
        window.location.reload();
      });
    } else {
      window.location.reload();
    }
  };

  // --- Main Game UI & Sync Logic ---
  function launchGame() {
    gameScreen.style.display = 'block';
    if (isHost) {
      playersInput.disabled = false;
      headerInput.disabled = false;
      timerInput.disabled = false;
      startTimerBtn.disabled = false;
      stopTimerBtn.disabled = false;
      resetTimerBtn.disabled = false;
      resetButton.disabled = false;
    } else {
      playersInput.disabled = true;
      headerInput.disabled = true;
      timerInput.disabled = true;
      startTimerBtn.disabled = true;
      stopTimerBtn.disabled = true;
      resetTimerBtn.disabled = true;
      resetButton.disabled = true;
    }
  }

  function generateBuzzers(count, namesArray = [], scoresArray = []) {
    buzzerRow.innerHTML = '';
    buzzers = []; nameInputs = []; scoreInputs = [];
    for (let i = 0; i < count; i++) {
      const container = document.createElement('div'); container.className = 'buzzer-container';
      const input = document.createElement('input');
      input.type = 'text'; input.placeholder = `Player ${i+1} Name`;
      input.className = 'name-input';
      input.value = namesArray[i] || '';
      if (!isHost) input.disabled = true;
      input.addEventListener('change', () => {
        if (isHost) {
          currentNames[i] = input.value;
          namesRef.set(currentNames);
        }
      });
      container.appendChild(input);
      const btn = document.createElement('button');
      btn.textContent = `Player ${i+1}`;
      btn.className = 'buzzer'; btn.style.backgroundColor = buzzerColors[i];
      btn.disabled = !isBuzzerActive || (!isHost && playerIndex !== i);
      btn.addEventListener('click', () => {
        if (isHost || playerIndex === i) {
          buzzRef.once('value').then(snap => {
            if (!snap.exists()) {
              const name = input.value.trim() || `Player ${i+1}`;
              buzzRef.set({ index: i, name, freq: buzzerFreqs[i], ts: Date.now() });
            }
          });
        }
      });
      container.appendChild(btn);
      const minusBtn = document.createElement('button');
      minusBtn.textContent = '-'; minusBtn.className = 'score-btn';
      const score = document.createElement('input');
      score.type = 'number'; score.value = scoresArray[i] || 0; score.className = 'score-input';
      score.disabled = !isHost;
      const plusBtn = document.createElement('button');
      plusBtn.textContent = '+'; plusBtn.className = 'score-btn';
      minusBtn.disabled = plusBtn.disabled = !isHost;
      minusBtn.onclick = () => {
        if (isHost) {
          currentScores[i] = Math.max(0, Number(score.value) - 1000);
          scoresRef.set(currentScores);
        }
      };
      plusBtn.onclick = () => {
        if (isHost) {
          currentScores[i] = Number(score.value) + 1000;
          scoresRef.set(currentScores);
        }
      };
      score.addEventListener('change', () => {
        if (isHost) {
          currentScores[i] = Number(score.value) || 0;
          scoresRef.set(currentScores);
        }
      });
      container.appendChild(minusBtn);
      container.appendChild(score);
      container.appendChild(plusBtn);
      buzzerRow.appendChild(container);
      buzzers.push(btn);
      nameInputs.push(input);
      scoreInputs.push(score);
    }
  }

  // --- Scoreboard Live Update + Download ---
  function updateScoreboard(names, scores) {
    let html = '';
    for (let i = 0; i < names.length; i++) {
      html += `<tr><td>Player ${i+1}</td><td>${names[i] || ''}</td><td>${scores[i] || 0}</td></tr>`;
    }
    scoreboardBody.innerHTML = html;
  }
  downloadBtn.onclick = function() {
    let csv = "Player,Name,Score\n";
    for (let i = 0; i < currentNames.length; i++) {
      csv += `Player ${i+1},"${(currentNames[i] || '').replace(/"/g,'""')}",${currentScores[i]||0}\n`;
    }
    let blob = new Blob([csv], { type: "text/csv" });
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "quiz_scores.csv";
    a.click();
  };

  // --- Timer and Firebase listeners ---
  function formatTime(t) {
    const min = Math.floor(t/60), sec = Math.floor(t%60), dsec = Math.floor((t*10)%10);
    return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}.${dsec}`;
  }
  function playBeep(frequency, duration) {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx     = new AudioContext();
    const gap = 0.05;
    const now = audioCtx.currentTime;
    const osc1 = audioCtx.createOscillator();
    const gain1 = audioCtx.createGain();
    osc1.connect(gain1); gain1.connect(audioCtx.destination);
    osc1.type = 'sine'; osc1.frequency.setValueAtTime(frequency, now);
    gain1.gain.setValueAtTime(0.5, now);
    osc1.start(now); osc1.stop(now + duration);
    const osc2 = audioCtx.createOscillator();
    const gain2 = audioCtx.createGain();
    osc2.connect(gain2); gain2.connect(audioCtx.destination);
    osc2.type = 'sine'; osc2.frequency.setValueAtTime(frequency * 1.25, now + duration + gap);
    gain2.gain.setValueAtTime(0.5, now + duration + gap);
    osc2.start(now + duration + gap); osc2.stop(now + 2*duration + gap);
  }
  function playAlarm() {
    let i = 0;
    function beep() {
      playBeep(1760, 0.2);
      i++;
      if (i < 3) setTimeout(beep, 300);
    }
    beep();
    timeoutPopup.style.display = "flex";
    setTimeout(() => { timeoutPopup.style.display = "none"; }, 4000);
  }

  // Host controls
  playersInput.onchange = function() {
    if (isHost) {
      let n = Math.max(2, Math.min(8, parseInt(playersInput.value) || 4));
      settingsRef.set({ header: headerInput.value.trim(), numPlayers: n });
      let arrN = Array.from({length: n}, (_,i) => currentNames && currentNames[i] ? currentNames[i] : '');
      let arrS = Array.from({length: n}, (_,i) => currentScores && currentScores[i] ? currentScores[i] : 0);
      namesRef.set(arrN);
      scoresRef.set(arrS);
      buzzRef.remove();
    }
  };
  headerInput.onchange = function() {
    if (isHost)
      settingsRef.set({ header: headerInput.value.trim(), numPlayers: parseInt(playersInput.value) });
  };
  timerInput.onchange = function() {
    if (isHost) {
      let t = Number(timerInput.value) || 30;
      timerRef.set({
        running: false,
        base: t,
        start: Date.now(),
        timeLeft: t
      });
    }
  };
  startTimerBtn.onclick = function() {
    if (isHost) {
      let t = Number(timerInput.value) || 30;
      timerRef.set({
        running: true,
        base: t,
        start: Date.now(),
        timeLeft: t
      });
    }
  };
  stopTimerBtn.onclick = function() {
    if (isHost) timerRef.child("running").set(false);
  };
  resetTimerBtn.onclick = function() {
    if (isHost) {
      let t = Number(timerInput.value) || 30;
      timerRef.set({
        running: false,
        base: t,
        start: Date.now(),
        timeLeft: t
      });
    }
  };
  resetButton.onclick = function() {
    if (isHost) buzzRef.remove();
  };

  // Real-time listeners
  settingsRef.on('value', snap => {
    const s = snap.val(); if (!s) return;
    headerInput.value = s.header;
    mainHeader.textContent = s.header;
    pageTitle.textContent  = s.header;
    if (parseInt(playersInput.value) !== s.numPlayers) {
      playersInput.value = s.numPlayers;
    }
    // Generate buzzers if needed
    namesRef.once('value').then(snapN => {
      let arrN = snapN.exists() ? snapN.val() : [];
      scoresRef.once('value').then(snapS => {
        let arrS = snapS.exists() ? snapS.val() : [];
        currentNames = arrN;
        currentScores = arrS;
        generateBuzzers(s.numPlayers, arrN, arrS);
        updateScoreboard(arrN, arrS);
      });
    });
  });
  namesRef.on('value', snap => {
    let arr = snap.exists() ? snap.val() : [];
    currentNames = arr;
    for (let i = 0; i < nameInputs.length; i++)
      if (arr[i] !== undefined) nameInputs[i].value = arr[i];
    updateScoreboard(currentNames, currentScores);
  });
  scoresRef.on('value', snap => {
    let arr = snap.exists() ? snap.val() : [];
    currentScores = arr;
    for (let i = 0; i < scoreInputs.length; i++)
      if (arr[i] !== undefined) scoreInputs[i].value = arr[i];
    updateScoreboard(currentNames, currentScores);
  });
  buzzRef.on('value', snap => {
    const b = snap.val();
    if (b) {
      isBuzzerActive = false;
      statusEl.textContent = `${b.name} buzzed first!`;
      playBeep(b.freq,0.3);
      for (let i = 0; i < buzzers.length; i++) buzzers[i].disabled = true;
      if (buzzers[b.index]) buzzers[b.index].disabled = false;
    } else {
      isBuzzerActive = true;
      statusEl.textContent = 'Ready';
      for (let i = 0; i < buzzers.length; i++)
        buzzers[i].disabled = (!isHost && playerIndex !== i) ? true : false;
    }
  });
  timerRef.on('value', snap => {
    const data = snap.val();
    if (!data) return;
    if (data.running) {
      let base = data.base || 30;
      let start = data.start || Date.now();
      clearInterval(timerInterval);
      function update() {
        let elapsed = (Date.now() - start) / 1000;
        let left = Math.max(0, base - elapsed);
        timerEl.textContent = formatTime(left);
        if (left <= 0) {
          timerEl.textContent = formatTime(0);
          clearInterval(timerInterval);
          playAlarm();
          timerRef.child('running').set(false);
        }
      }
      update();
      timerInterval = setInterval(update, 100);
    } else {
      clearInterval(timerInterval);
      let t = data.timeLeft !== undefined ? data.timeLeft : data.base || 30;
      timerEl.textContent = formatTime(t);
    }
  });

  // On load, set up default
  settingsRef.once('value').then(snap => {
    if (!snap.exists()) {
      settingsRef.set({ header: "Oliver's Quiz Game", numPlayers: 4 });
      namesRef.set(['','','','']);
      scoresRef.set([0,0,0,0]);
      timerRef.set({
        running: false,
        base: 30,
        start: Date.now(),
        timeLeft: 30
      });
    }
  });
</script>
