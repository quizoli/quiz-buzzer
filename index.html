<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="page-title">Oliver's Quiz Game</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; }
    .buzzer-row { display: flex; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
    .buzzer-container { margin: 10px; text-align: center; }
    .buzzer { width: 100px; height: 100px; border: none; border-radius: 50%; font-size: 16px; cursor: pointer; transition: transform 0.1s ease; }
    .buzzer:active { transform: scale(0.95); }
    .disabled { background-color: #ccc !important; cursor: not-allowed; }
    .name-input, .header-input, .players-input, .password-input, .slot-select { padding: 8px; font-size: 16px; width: 150px; }
    .score-input { padding: 8px; font-size: 16px; width: 60px; margin: 0 5px; }
    .score-btn { padding: 5px 12px; margin: 0 2px; font-size: 18px; border-radius: 10px; border: none; }
    .header-container, .players-container, .password-container, .login-container { margin-bottom: 20px; }
    #login-screen { display: block; margin-top: 50px; }
    #password-screen, #game-screen, #player-setup-screen { display: none; }
    #timer-container { margin-top: 15px; margin-bottom: 15px; }
    #timer { font-size: 2em; padding: 10px; margin-right: 20px; }
    #timer-controls button { padding: 8px 18px; margin: 0 5px; font-size: 1em; border-radius: 8px; border: none; }
    #timer-input { width: 70px; font-size: 1.2em; margin-right: 12px; }
    #scoreboard { background: #fff; border-radius: 15px; box-shadow: 0 0 8px #ccc; margin: 30px auto 10px auto; max-width: 600px; padding: 16px 10px 10px 10px; }
    #scoreboard h2 { margin-top: 0; font-size: 1.5em; }
    #scoreboard-table { width: 100%; font-size: 1.3em; border-collapse: collapse; margin-bottom: 0; }
    #scoreboard-table th, #scoreboard-table td { border-bottom: 1px solid #eee; padding: 6px 8px; }
    #timeout-popup { display:none; position: fixed; left:0; top:0; width:100vw; height:100vh; background: rgba(0,0,0,0.6); z-index: 20; justify-content: center; align-items: center; }
    #timeout-popup-inner { background: #fff; padding: 40px 40px; border-radius: 20px; box-shadow: 0 0 16px #444; font-size: 2.2em; color: #c00; animation: flashbg 0.3s linear 0s 6 alternate; }
    @keyframes flashbg { from { background: #fff; } to { background: #ffcccc; } }
    #leave-btn { position: fixed; top: 18px; right: 25px; padding: 8px 20px; font-size: 1em; background: #fff8f0; border-radius: 9px; border:1px solid #fa8072; color: #d94d3a; cursor: pointer; z-index:10; }
    #download-btn { margin-left: 14px; padding: 8px 16px; border-radius: 8px; border: 1px solid #007bff; color: #007bff; background: #f6faff; font-size: 1em; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="login-screen" class="container">
    <h1>Oliver's Quiz Game</h1>
    <div class="login-container">
      <button id="host-login-btn">Login as Host</button>
      <button id="player-login-btn">Login as Player</button>
    </div>
    <div id="waiting-host" style="color:#e0671b; margin-top:30px; font-size:1.4em; display:none;">
      Waiting for host to start the game...
    </div>
  </div>
  <div id="password-screen" class="container">
    <h2>Host Authentication</h2>
    <div class="password-container">
      <label>Password:</label>
      <input type="password" id="password-input" class="password-input">
      <button id="auth-button" class="auth-button">Login</button>
    </div>
    <div id="auth-error" style="color: red; margin-top: 10px;"></div>
  </div>
  <div id="player-setup-screen" class="container" style="display:none;">
    <h2>Player Login</h2>
    <div class="login-container">
      <label>Choose Player Slot:</label>
      <select id="player-slot" class="slot-select">
        <option value="0">Player 1</option>
        <option value="1">Player 2</option>
        <option value="2">Player 3</option>
        <option value="3">Player 4</option>
        <option value="4">Player 5</option>
        <option value="5">Player 6</option>
        <option value="6">Player 7</option>
        <option value="7">Player 8</option>
      </select>
      <br/><br/>
      <label>Your Name:</label>
      <input type="text" id="player-name-input" class="name-input">
      <button id="player-login-confirm-btn">Login</button>
    </div>
    <div id="player-login-error" style="color: red; margin-top: 10px;"></div>
  </div>
  <button id="leave-btn" style="display:none;">Leave Game</button>
  <div id="timeout-popup"><div id="timeout-popup-inner">TIME'S UP!</div></div>
  <div id="game-screen" class="container">
    <div class="header-container">
      <label>Quiz Title:</label>
      <input type="text" id="header-input" class="header-input" value="Oliver's Quiz Game">
    </div>
    <h1 id="main-header">Oliver's Quiz Game</h1>
    <div class="players-container">
      <label>Number of Players (2-8):</label>
      <input type="number" id="players-input" class="players-input" value="4" min="2" max="8">
    </div>
    <div id="timer-container">
      <input type="number" id="timer-input" min="1" value="30" /> seconds
      <span id="timer">00:30.0</span>
      <span id="timer-controls">
        <button id="start-timer-btn">Start</button>
        <button id="stop-timer-btn">Stop</button>
        <button id="reset-timer-btn">Reset</button>
      </span>
    </div>
    <div id="scoreboard">
      <h2>Scoreboard</h2>
      <table id="scoreboard-table">
        <thead><tr><th>Player</th><th>Name</th><th>Score</th></tr></thead>
        <tbody id="scoreboard-body"></tbody>
      </table>
      <button id="download-btn">Download Scores (CSV)</button>
    </div>
    <div id="status">Ready</div>
    <div id="buzzer-row" class="buzzer-row"></div>
    <button id="reset" style="margin-top:20px;">Reset</button>
  </div>
<script>
// Firebase & DOM setup
const firebaseConfig = {
  apiKey: "AIzaSyAN7_tf4JxF4rzafGLZidbuUlPSxNPgyvE",
  authDomain: "oliver-s-quiz-game.firebaseapp.com",
  databaseURL: "https://oliver-s-quiz-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "oliver-s-quiz-game",
  storageBucket: "oliver-s-quiz-game.appspot.com",
  messagingSenderId: "273095657187",
  appId: "1:273095657187:web:4bc4b0f662d3c60afd27d6",
  measurementId: "G-T13MW2BD3Z"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const settingsRef = db.ref('games/quizGame/settings');
const buzzRef     = db.ref('games/quizGame/buzz');
const namesRef    = db.ref('games/quizGame/names');
const scoresRef   = db.ref('games/quizGame/scores');
const timerRef    = db.ref('games/quizGame/timer');
const hostPresenceRef = db.ref('games/quizGame/hostPresent');
// DOM
const loginScreen   = document.getElementById('login-screen');
const passwordScreen= document.getElementById('password-screen');
const playerScreen  = document.getElementById('player-setup-screen');
const gameScreen    = document.getElementById('game-screen');
const hostBtn       = document.getElementById('host-login-btn');
const playerBtn     = document.getElementById('player-login-btn');
const authBtn       = document.getElementById('auth-button');
const leaveBtn      = document.getElementById('leave-btn');
const timerEl       = document.getElementById('timer');
// state
let isHost=false, playerIndex=null, currentNames=[], currentScores=[],
    buzzers=[], nameInputs=[], scoreInputs=[], isActive=true, timerInt;
const colors=['#ff4d4d','#4d79ff','#4dff4d','#ffcc00','#ff33cc','#33cccc','#cc33ff','#ff9933'];
const freqs =[440,523.25,659.25,880,987.77,1108.73,1318.51,1760];
// Utility: generate buzzers
function generateBuzzers(n,names,scores){
  const row=document.getElementById('buzzer-row');
  row.innerHTML=''; buzzers=[]; nameInputs=[]; scoreInputs=[];
  for(let i=0;i<n;i++){
    const c=document.createElement('div');c.className='buzzer-container';
    // name input
    const ni=document.createElement('input');ni.type='text';ni.value=names[i]||'';ni.disabled=!isHost;
    ni.addEventListener('change',()=>{ if(isHost){currentNames[i]=ni.value;namesRef.set(currentNames);} });
    c.appendChild(ni); nameInputs.push(ni);
    // buzzer button
    const b=document.createElement('button');b.textContent=`P${i+1}`;b.className='buzzer';
    b.style.background=colors[i]; b.disabled=!isActive||(!isHost&&playerIndex!==i);
    b.onclick=()=>{ if(isHost||playerIndex===i) buzzRef.once('value').then(s=>{
      if(!s.exists()) buzzRef.set({index:i,name:ni.value||`P${i+1}`,freq:freqs[i]});
    });};
    c.appendChild(b); buzzers.push(b);
    // score controls
    const minus=document.createElement('button');minus.textContent='-';minus.disabled=!isHost;
    const score=document.createElement('input');score.type='number';score.value=scores[i]||0;score.disabled=!isHost;
    const plus=document.createElement('button');plus.textContent='+';plus.disabled=!isHost;
    minus.onclick=()=>{ if(isHost){currentScores[i]=Math.max(0,score.value-1000);scoresRef.set(currentScores);} };
    plus.onclick =()=>{ if(isHost){currentScores[i]=Number(score.value)+1000;scoresRef.set(currentScores);} };
    c.append(minus,score,plus); scoreInputs.push(score);
    row.appendChild(c);
  }
}// scoreboard update
function updateScoreboard(names,scores){
  const tbody=document.getElementById('scoreboard-body');
  tbody.innerHTML=names.map((n,i)=>`<tr><td>${i+1}</td><td>${n||''}</td><td>${scores[i]||0}</td></tr>`).join('');
}
document.getElementById('download-btn').onclick=()=>{
  let csv="Player,Name,Score\n";
  currentNames.forEach((n,i)=>csv+=`${i+1},"${n}",${currentScores[i]||0}\n`);
  const blob=new Blob([csv],{type:'text/csv'}),a=document.createElement('a');
  a.href=URL.createObjectURL(blob);a.download="scores.csv";a.click();
};
// timer
function formatTime(t){
  const m=Math.floor(t/60),s=Math.floor(t%60),d=Math.floor((t*10)%10);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${d}`;
}
function startTimer(){
  timerRef.set({running:true,base:Number(document.getElementById('timer-input').value)||30,start:Date.now()});
}
function stopTimer(){timerRef.child('running').set(false);}
function resetTimer(){
  timerRef.set({running:false,base:Number(document.getElementById('timer-input').value)||30,start:Date.now(),left:document.getElementById('timer-input').value});
}
// sync controls
document.getElementById('start-timer-btn').onclick=startTimer;
document.getElementById('stop-timer-btn').onclick=stopTimer;
document.getElementById('reset-timer-btn').onclick=resetTimer;
document.getElementById('players-input').onchange=e=>{
  if(isHost)settingsRef.set({header:document.getElementById('header-input').value,numPlayers:Number(e.target.value)});
};
document.getElementById('header-input').onchange=e=>{
  if(isHost)settingsRef.child('header').set(e.target.value);
};
document.getElementById('reset').onclick=()=>{ if(isHost) buzzRef.remove(); };
// realtime listeners
settingsRef.on('value',s=>{
  const v=s.val(); if(!v) return;
  document.getElementById('header-input').value=v.header;
  document.getElementById('main-header').textContent=v.header;
  document.getElementById('page-title').textContent=v.header;
  document.getElementById('players-input').value=v.numPlayers;
  namesRef.once('value').then(n=>scoresRef.once('value').then(sc=>{
    currentNames=n.val()||[];currentScores=sc.val()||[];
    generateBuzzers(v.numPlayers,currentNames,currentScores);
    updateScoreboard(currentNames,currentScores);
  }));
});
namesRef.on('value',s=>{currentNames=s.val()||[];updateScoreboard(currentNames,currentScores);});
scoresRef.on('value',s=>{currentScores=s.val()||[];updateScoreboard(currentNames,currentScores);});
buzzRef.on('value',s=>{
  const b=s.val();
  isActive=!b; document.getElementById('status').textContent=b?`${b.name} buzzed first!`:'Ready';
  buzzers.forEach((btn,i)=>btn.disabled=b||(!isHost&&i!==playerIndex));
  if(b) playBeep(b.freq,0.3);
});
timerRef.on('value',s=>{
  const d=s.val(); if(!d)return;
  clearInterval(timerInt);
  if(d.running){
    timerInt=setInterval(()=>{
      const left=Math.max(0,d.base-(Date.now()-d.start)/1000);
      timerEl.textContent=formatTime(left);
      if(left<=0){clearInterval(timerInt);playAlarm();timerRef.child('running').set(false);}
    },100);
  } else {
    timerEl.textContent=formatTime(d.base);
  }
});
// host presence
hostPresenceRef.on('value',s=>{
  const p=s.val();
  if(!p){document.getElementById('login-screen').style.display='block';}
});
// login logic
hostBtn.onclick=()=>{loginScreen.style.display='none';passwordScreen.style.display='block';};
authBtn.onclick=()=>{
  if(passwordInput.value==='quizmaster123'){
    isHost=true;passwordScreen.style.display='none';leaveBtn.style.display='block';
    hostPresenceRef.set(true);window.addEventListener('beforeunload',()=>hostPresenceRef.set(false));
    settingsRef.once('value',s=>{if(!s.exists())settingsRef.set({header:"Oliver's Quiz Game",numPlayers:4});});
  } else alert('Wrong password');
};
playerBtn.onclick=()=>{hostPresenceRef.once('value',s=>{
  if(s.val()){loginScreen.style.display='none';playerScreen.style.display='block';}
  else alert('Wait for host');
})};
document.getElementById('player-login-confirm-btn').onclick=()=>{const idx=+playerSlot.value;let nm=playerNameInput.value||`P${idx+1}`;
  namesRef.once('value').then(s=>{let arr=s.val()||[];arr[idx]=nm;namesRef.set(arr);playerScreen.style.display='none';leaveBtn.style.display='block';});
};
// initial setup
settingsRef.once('value',s=>{if(!s.exists())settingsRef.set({header:"Oliver's Quiz Game",numPlayers:4});});
</script>
</body>
</html>
